<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خدمة العملاء | 3CX Quick Call</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --txt:#111; --muted:#6b7280; --brand:#2563eb; --ok:#16a34a; --err:#dc2626;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f19; --card:#111827; --txt:#f9fafb; --muted:#9ca3af; --shadow: 0 10px 30px rgba(0,0,0,.35); }
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Tajawal", Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg) 70%, #fff));
      color:var(--txt);
    }
    .wrap{ max-width:860px; margin:5rem auto; padding:0 1rem; }
    .hero{
      background: radial-gradient(1200px 400px at 85% -50%, rgba(37,99,235,.15), transparent),
                  radial-gradient(1200px 400px at -10% -60%, rgba(16,185,129,.12), transparent);
      border:1px solid color-mix(in oklab, var(--card), #000 6%);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:2rem clamp(1.2rem, 3vw, 2rem);
    }
    .hero h1{ margin:.2rem 0 0; font-size: clamp(1.4rem, 2.8vw, 2rem); }
    .hero p{ margin:.6rem 0 0; color:var(--muted) }
    .cta{
      margin-top:1.25rem; display:flex; gap:.8rem; flex-wrap:wrap; align-items:center
    }
    .btn{
      appearance:none; cursor:pointer; border:0; border-radius:12px;
      padding:.85rem 1.1rem; font-weight:600; font-size:1rem; transition:.2s ease;
      background:var(--brand); color:#fff; box-shadow: 0 8px 20px rgba(37,99,235,.25);
    }
    .btn:hover{ filter:brightness(1.05) }
    .note{ color:var(--muted); font-size:.95rem }

    /* عارض نتيجة/سجلات صغير */
    .log{
      margin-top:1rem; background:var(--card); border:1px dashed color-mix(in oklab, var(--card), #000 10%);
      border-radius:12px; padding:.9rem; font: 500 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap; max-height:220px; overflow:auto
    }

    /* زر 3CX العائم */
    .fab{
      position: fixed; inset-block-end: 24px; inset-inline-end: 24px;
      width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
      background:#0b1a2e; box-shadow: var(--shadow); border:1px solid #1f2b40; cursor:pointer;
    }
    .fab img{ width:60%; height:60%; object-fit:contain; filter: drop-shadow(0 2px 8px rgba(0,0,0,.25)); }
    .fab:active{ transform: translateY(1px); }

    /* النافذة المنبثقة */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; padding:1rem;
      background: color-mix(in oklab, #000 60%, transparent); z-index:50;
    }
    .modal[open]{ display:grid; animation:fade .15s ease }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }
    .sheet{
      width:min(520px, 100%); background:var(--card); color:var(--txt);
      border-radius:16px; padding:1.25rem 1.25rem 1rem; box-shadow: var(--shadow);
      border:1px solid color-mix(in oklab, var(--card), #000 6%);
    }
    .sheet h3{ margin:.2rem 0 0; font-size:1.15rem }
    .field{ margin:.9rem 0 .4rem }
    label{ display:block; margin-bottom:.4rem; color:var(--muted) }
    input[type="tel"]{
      width:100%; padding:.85rem 1rem; border-radius:12px; background:transparent;
      border:1px solid color-mix(in oklab, var(--card), #000 12%); color:inherit; font-size:1rem;
      outline: none;
    }
    .row{ display:flex; gap:.7rem; justify-content:flex-start; margin-top:.9rem; flex-wrap:wrap }
    .btn.secondary{ background:transparent; color:var(--txt); border:1px solid color-mix(in oklab, var(--card), #000 12%); box-shadow:none }
    .status{ margin-top:.7rem; font-size:.95rem }
    .status.ok{ color:var(--ok) } .status.err{ color:var(--err) }

    /* زر رئيسي في الهيدر (اختياري) */
    .ghost{ background:transparent; color:var(--brand); border:1px solid color-mix(in oklab, var(--brand), #000 25%) }
  </style>
</head>
<body>

  <div class="wrap">
    <section class="hero">
      <h6 style="margin:0;color:var(--muted);font-weight:600">خدمة العملاء</h6>
      <h1>مرحبًا بكم في صفحة خدمة العملاء</h1>
      <p>يمكنك البدء باتصال فوري عبر سنترال <b>3CX</b>. اضغط الزر بالأسفل أو زر 3CX العائم، وأدخل رقم الوجهة (مثل 201) ليقوم النظام بالاتصال من تحويلة <b>327</b> إلى الرقم الذي تختاره.</p>

      <div class="cta">
        <button class="btn" id="open-modal">بدء اتصال الآن</button>
        <span class="note">الاتصال متاح للأرقام الداخلية أو الخارجية (+‪E.164‬).</span>
      </div>

      <pre class="log" id="log" aria-live="polite">جاهز.</pre>
    </section>
  </div>

  <!-- زر 3CX العائم (استخدم شعار 3CX، ضع صورة محلية /3cx-logo.png أو اترك الافتراضي) -->
  <button class="fab" id="fab" title="اتصل عبر 3CX">
    <img src="https://www.3cx.com/wp-content/uploads/2019/12/3CX-Logo-1.svg" alt="3CX" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 rx=%2212%22 fill=%230b1a2e/><text x=%2232%22 y=%2238%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2224%22 fill=%22%23fff%22>3CX</text></svg>'">
  </button>

  <!-- النافذة المنبثقة -->
  <dialog class="modal" id="modal">
    <div class="sheet" role="document">
      <h3>الاتصال عبر 3CX</h3>
      <div class="field">
        <label for="to">أدخل الرقم المراد الاتصال به</label>
        <input id="to" inputmode="tel" type="tel" placeholder="مثال: 201 أو +9715XXXXXXX" autocomplete="off" />
      </div>
      <div class="row">
        <button class="btn" id="call-btn">اتصال</button>
        <button class="btn secondary" id="close-modal">إلغاء</button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </dialog>

  <script>
    const modal = document.getElementById('modal');
    const openModal = document.getElementById('open-modal');
    const closeModal = document.getElementById('close-modal');
    const fab = document.getElementById('fab');
    const input = document.getElementById('to');
    const callBtn = document.getElementById('call-btn');
    const log = document.getElementById('log');

    const open = () => {
      modal.setAttribute('open', '');
      input.value = '';
      input.focus();
      document.addEventListener('keydown', escClose, { once:true });
    };
    const close = () => {
      modal.removeAttribute('open');
      document.removeEventListener('keydown', escClose);
    };
    const escClose = (e) => { if (e.key === 'Escape') close(); };

    openModal.addEventListener('click', open);
    fab.addEventListener('click', open);
    closeModal.addEventListener('click', close);
    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

    function print(x){ log.textContent = (typeof x === 'string') ? x : JSON.stringify(x, null, 2); }

    async function queueCall(to){
      print('جارٍ تجهيز الطلب…');
      const ALLOWED = /^[0-9+*#]{2,32}$/;
      if(!ALLOWED.test((to||'').trim())){
        print({ error: 'الرقم غير صالح', to });
        return { ok:false };
      }
      try{
        const res = await fetch('/.netlify/functions/enqueue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to })
        });
        const txt = await res.text();
        let data; try{ data = JSON.parse(txt); } catch{ data = { raw: txt || null }; }
        print(data);
        return { ok: res.ok, data };
      }catch(err){
        print({ error: err.message });
        return { ok:false };
      }
    }

    callBtn.addEventListener('click', async () => {
      const to = input.value.trim();
      callBtn.disabled = true; callBtn.textContent = 'جارٍ الاتصال…';
      document.getElementById('status').textContent = '';
      const result = await queueCall(to);
      callBtn.disabled = false; callBtn.textContent = 'اتصال';
      const st = document.getElementById('status');
      if(result.ok){ st.textContent = '✔ تم إرسال الطلب إلى 3CX.'; st.className = 'status ok'; }
      else{ st.textContent = '✖ لم ينجح الإرسال. تحقّق من الصلاحيات/الإعدادات.'; st.className = 'status err'; }
    });
  </script>
</body>
</html>
