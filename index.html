<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Study Upload – Telephony Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="app-shell">
  <div class="card">
    <div class="card-header">
      <div class="card-title">
        <h1>Study Upload Portal</h1>
        <p>
          Upload screenshots, diagrams, configs. n8n + Gemini will auto-create
          the right project/subject.
        </p>
      </div>
    <div class="card-badge">
    <span id="connectionDot" class="card-badge-dot card-badge-dot--disconnected"></span>
    <span>Connected to n8n</span>
      </div>

    </div>

    <!-- Upload area -->
    <div id="uploadArea" class="upload-area">
      <strong>Click to choose images</strong>
      <p>or drag &amp; drop PNG / JPG / WEBP here</p>
      <input
        id="fileInput"
        type="file"
        accept="image/*"
        multiple
        style="display: none"
      />
      <div id="fileCount" class="upload-file-count">No files selected</div>
    </div>

    <!-- Optional note -->
    <div class="note-field">
      <div class="note-label">
        Optional note / description
        <span style="opacity: 0.7">(helps Gemini understand context)</span>
      </div>
      <textarea
        id="noteInput"
        class="note-input"
        placeholder="Example: Yeastar TG200 SIP trunk with 3CX, customer X; Grandstream doorphone wiring; 3CX outbound rule test…"
      ></textarea>
    </div>

    <div class="actions-row">
      <button id="uploadBtn" class="btn btn-primary">
        ⬆ Upload to n8n
      </button>
      <div class="actions-hint">
        n8n workflow should receive the images, call Gemini to detect the
        subject, and create/update projects automatically.
      </div>
    </div>

    <div id="status" class="status"></div>

    <div id="recent" class="recent-list" style="display: none;">
      <div>Last uploaded items (from n8n response):</div>
      <ul id="recentList"></ul>
    </div>
  </div>
</div>

<script>
  // =============================
  //  CONFIG – CHANGE THIS URL
  // =============================
  // n8n Webhook that receives the images.
  // It should accept multipart/form-data with:
  //   files[] (binary)  and  note  (string)
  //
  // Example path:  /webhook/upload-study-images
const N8N_UPLOAD_URL = "https://rafii.app.n8n.cloud/webhook/upload-study-images";
const N8N_LOAD_URL   = "https://rafii.app.n8n.cloud/webhook-test/load-study-images";

  // =============================

  const fileInput = document.getElementById("fileInput");
  const uploadArea = document.getElementById("uploadArea");
  const fileCount = document.getElementById("fileCount");
  const noteInput = document.getElementById("noteInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const statusEl = document.getElementById("status");
  const recentEl = document.getElementById("recent");
  const recentListEl = document.getElementById("recentList");
  
async function loadSubjects() {
  try {
    const res = await fetch(N8N_LOAD_URL, { method: "GET" });
    if (!res.ok) throw new Error("Status " + res.status);
    const data = await res.json();
    console.log("Subjects:", data);
    // هنا ترسم الـ subjects في الصفحة...
  } catch (err) {
    console.error("Failed to load subjects", err);
  }
}

  // ---- Helpers ----
  function setStatus(message, type) {
    statusEl.textContent = message || "";
    statusEl.classList.remove("status--ok", "status--error");
    if (type === "ok") statusEl.classList.add("status--ok");
    if (type === "error") statusEl.classList.add("status--error");
  }

  function updateFileCount() {
    const count = fileInput.files.length;
    fileCount.textContent =
      count === 0
        ? "No files selected"
        : count + " file" + (count > 1 ? "s" : "") + " selected";
  }

  // ---- Upload area interactions ----
  uploadArea.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", updateFileCount);

  ["dragenter", "dragover"].forEach((evt) => {
    uploadArea.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add("drag-over");
    });
  });

  ["dragleave", "drop"].forEach((evt) => {
    uploadArea.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove("drag-over");
    });
  });

  uploadArea.addEventListener("drop", (e) => {
    const files = e.dataTransfer.files;
    if (files && files.length) {
      fileInput.files = files;
      updateFileCount();
      loadSubjects();

    }
  });

  // ---- Upload to n8n ----
uploadBtn.addEventListener("click", async () => {
    if (!fileInput.files.length) {
      setStatus("Please choose at least one image first.", "error");
      return;
    }

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploading…";
    setStatus("Uploading to n8n…", null);

    try {
      const formData = new FormData();
      Array.from(fileInput.files).forEach((file) => {
        formData.append("files", file);
      });
      formData.append("note", noteInput.value.trim());

      const res = await fetch(N8N_UPLOAD_URL, {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        throw new Error("n8n response status " + res.status);
      }

      const data = await res.json().catch(() => ({}));
      console.log("n8n response:", data); // <— see this in browser console

      setStatus("Upload complete. Gemini will now sort your images.", "ok");

      // Reset fields
      fileInput.value = "";
      noteInput.value = "";
      updateFileCount();

      // Show recent list if backend sent items
      recentListEl.innerHTML = "";     // clear
      if (data && Array.isArray(data.items) && data.items.length) {
        data.items.forEach((item) => {
          const li = document.createElement("li");
          const subject = item.subject || item.project || "Unknown subject";
          li.textContent = (item.filename || "image") + " → " + subject;
          recentListEl.appendChild(li);
        });
      } else {
        // fallback: show raw JSON
        const li = document.createElement("li");
        li.textContent = "Raw n8n response: " + JSON.stringify(data);
        recentListEl.appendChild(li);
      }
      recentEl.style.display = "block";
    } catch (err) {
      console.error(err);
      setStatus("Upload failed: " + err.message, "error");
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "⬆ Upload to n8n";
    }
  });

  // Initial state
  updateFileCount();
</script>
</body>
</html>
