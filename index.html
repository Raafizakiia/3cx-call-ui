<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خدمة العملاء | 3CX Quick Call</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b1220; --txt:#f8fafc; --muted:#a3aed0; --brand:#2563eb; --glass:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12); --shadow: 0 10px 30px rgba(0,0,0,.4); --radius: 18px;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Tajawal", "Noto Kufi Arabic", Arial, sans-serif;
      min-height:100svh;
      /* خلفية مزخرفة */
      background:
        radial-gradient(1200px 600px at 110% -20%, rgba(37,99,235,.25), transparent),
        radial-gradient(1000px 500px at -10% -10%, rgba(16,185,129,.14), transparent),
        linear-gradient(180deg, #0b1220 0%, #0e1528 100%);
    }
    .wrap{ max-width:880px; margin:6rem auto; padding:0 1.2rem; }
    .hero{
      position:relative; overflow:hidden;
      border:1px solid var(--border);
      background: color-mix(in oklab, var(--glass) 100%, transparent);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: clamp(1.2rem, 3vw, 2rem);
    }
    .hero::after{
      content:""; position:absolute; inset:auto -10% -40% -10%;
      height:160px; background: radial-gradient(600px 120px at 50% 0%, rgba(37,99,235,.25), transparent);
      filter: blur(30px);
    }
    h1{ margin:.2rem 0 0; font-size: clamp(1.4rem, 3.1vw, 2.2rem) }
    p{ margin:.7rem 0 0; color:var(--muted) }
    .cta{ margin-top:1.2rem; display:flex; gap:.8rem; flex-wrap:wrap; align-items:center }
    .btn{
      appearance:none; cursor:pointer; border:1px solid color-mix(in oklab, var(--brand), #000 35%);
      background: linear-gradient(180deg, color-mix(in oklab, var(--brand), #fff 10%), var(--brand));
      color:#fff; font-weight:700; padding:.9rem 1.2rem; border-radius:14px; box-shadow:0 10px 24px rgba(37,99,235,.25);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:hover{ filter:brightness(1.05) } .btn:active{ transform: translateY(1px) }
    .note{ color:var(--muted); font-size:.95rem }

    /* زر 3CX العائم بإيقونة SVG مدمجة */
    .fab{
      position: fixed; inset-block-end: 24px; inset-inline-end: 24px; z-index: 50;
      width:62px; height:62px; border-radius:50%;
      display:grid; place-items:center; cursor:pointer;
      background:#0b1a2e; border:1px solid #1f2b40; box-shadow: var(--shadow);
    }
    .fab svg{ width:64%; height:64%; }
    .fab:active{ transform: translateY(1px) }

    /* النافذة المنبثقة */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; padding:1rem;
      background: rgba(0,0,0,.5);
    }
    .modal[open]{ display:grid; animation:fade .12s ease }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }
    .sheet{
      width:min(520px, 100%); background: rgba(17,24,39,.9); color:var(--txt);
      border-radius:16px; padding:1.25rem 1.25rem 1rem; box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    .sheet h3{ margin:.2rem 0 .6rem; font-size:1.15rem }
    label{ display:block; margin:.4rem 0; color:var(--muted) }
    input[type="tel"]{
      width:100%; padding:1rem; border-radius:12px; background:#0f1627; color:inherit;
      border:1px solid color-mix(in oklab, #ffffff, #000 85%);
      outline:none;
    }
    .row{ display:flex; gap:.7rem; margin-top:.9rem; flex-wrap:wrap }
    .btn.secondary{ background:transparent; color:#e2e8f0; border-color: color-mix(in oklab, #ffffff, #000 80%); box-shadow:none }
    .status{ margin-top:.6rem; font-size:.95rem; min-height:1.2em; color:var(--muted) }
    .status.ok{ color:#22c55e } .status.err{ color:#ef4444 }
  </style>
</head>
<body>

  <div class="wrap">
    <section class="hero" aria-label="خدمة العملاء">
      <h6 style="margin:0;color:var(--muted);font-weight:700">خدمة العملاء</h6>
      <h1>مرحبًا بكم في صفحة خدمة العملاء</h1>
      <p>يمكنك البدء باتصال فوري عبر سنترال <b>3CX</b>. اضغط الزر أدناه أو الزر العائم، وأدخل رقم الوجهة (مثل <b>201</b>) ليقوم النظام بالاتصال من تحويلة <b>327</b> إلى الرقم المطلوب.</p>
      <div class="cta">
        <button class="btn" id="open-modal" aria-haspopup="dialog">بدء اتصال الآن</button>
        <span class="note">يدعم الأرقام الداخلية والخارجية (+E.164).</span>
      </div>
      <!-- تمت إزالة عرض المخرجات على الصفحة بناءً على طلبك -->
    </section>
  </div>

  <!-- زر 3CX العائم (SVG مضمّن) -->
  <button class="fab" id="fab" title="اتصل عبر 3CX" aria-label="اتصل عبر 3CX">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <rect x="0" y="0" width="64" height="64" rx="16" fill="#0b1a2e"/>
      <text x="50%" y="56%" text-anchor="middle" font-family="Segoe UI, Arial, sans-serif" font-size="28" fill="#ffffff" font-weight="700">3CX</text>
    </svg>
  </button>

  <!-- النافذة المنبثقة -->
  <dialog class="modal" id="modal" aria-modal="true" aria-labelledby="modal-title">
    <div class="sheet">
      <h3 id="modal-title">الاتصال عبر 3CX</h3>
      <label for="to">أدخل الرقم المراد الاتصال به</label>
      <input id="to" inputmode="tel" type="tel" placeholder="مثال: 201 أو +9715XXXXXXX" autocomplete="off" />
      <div class="row">
        <button class="btn" id="call-btn">اتصال</button>
        <button class="btn secondary" id="close-modal">إلغاء</button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </dialog>

  <script>
    // عناصر
    const modal = document.getElementById('modal');
    const openModal = document.getElementById('open-modal');
    const closeModal = document.getElementById('close-modal');
    const fab = document.getElementById('fab');
    const input = document.getElementById('to');
    const callBtn = document.getElementById('call-btn');
    const statusEl = document.getElementById('status');

    // فتح/إغلاق
    const open = () => { modal.setAttribute('open',''); input.value=''; input.focus(); document.addEventListener('keydown', escClose, { once:true }); };
    const close = () => { modal.removeAttribute('open'); };
    const escClose = (e) => { if(e.key==='Escape') close(); };
    openModal.addEventListener('click', open);
    fab.addEventListener('click', open);
    closeModal.addEventListener('click', close);
    modal.addEventListener('click', e => { if(e.target===modal) close(); });

    // اتصال
    async function queueCall(to){
      const ALLOWED = /^[0-9+*#]{2,32}$/;
      if(!ALLOWED.test((to||'').trim())){
        statusEl.textContent = 'الرقم غير صالح.';
        statusEl.className = 'status err';
        return { ok:false };
      }
      try{
        const res = await fetch('/.netlify/functions/enqueue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to })
        });
        const txt = await res.text();
        let data; try{ data = JSON.parse(txt); } catch { data = { raw: txt || null }; }
        // لا نطبع أي JSON على الصفحة كما طلبت — فقط حالة مختصرة:
        if(res.ok){
          statusEl.textContent = '✔ تم إرسال الطلب إلى 3CX.';
          statusEl.className = 'status ok';
        }else{
          statusEl.textContent = '✖ لم ينجح الإرسال. تحقّق من الصلاحيات/الإعدادات.';
          statusEl.className = 'status err';
        }
        // لتتبّع داخلي فقط:
        console.debug('enqueue result:', data);
        return { ok: res.ok, data };
      }catch(err){
        statusEl.textContent = 'خطأ في الاتصال بالخادم.';
        statusEl.className = 'status err';
        console.error(err);
        return { ok:false };
      }
    }

    callBtn.addEventListener('click', async () => {
      const to = input.value.trim();
      callBtn.disabled = true;
      callBtn.textContent = 'جارٍ الإرسال…';
      statusEl.textContent = '';
      const result = await queueCall(to);
      callBtn.disabled = false;
      callBtn.textContent = 'اتصال';
      if(result.ok){ setTimeout(close, 1200); }
    });
  </script>
  <script>
  // عناصر واجهة AI
  const aiModal = document.getElementById('ai-modal');
  const aiFab = document.getElementById('ai-fab');
  const aiSend = document.getElementById('ai-send');
  const aiInput = document.getElementById('ai-input');
  const chatBox = document.getElementById('chat-box');

  // فتح النافذة
  aiFab.onclick = () => {
    aiModal.setAttribute('open','');
    aiInput.focus();
  };

  // دالة النطق الصوتي
  function speak(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ar-SA"; // اللغة: عربي
    u.rate = 1;
    speechSynthesis.speak(u);
  }

  // عند الضغط على إرسال
  aiSend.onclick = async () => {
    const msg = aiInput.value.trim();
    if(!msg) return;

    // أضف رسالة المستخدم
    chatBox.innerHTML += `<div style="color:#38bdf8;margin:.3rem 0">👤: ${msg}</div>`;
    aiInput.value = '';

    // استدعاء دالة Netlify (chat.js)
    const res = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ message: msg })
    });

    const data = await res.json();
    const reply = data.reply || "لم أفهم، حاول مرة أخرى.";

    // أضف رد البوت
    chatBox.innerHTML += `<div style="color:#22c55e;margin:.3rem 0">🤖: ${reply}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    // نطق الرد
    speak(reply);
  };
</script>

  <button class="fab" id="ai-fab" title="مساعد AI" aria-label="مساعد AI">🤖</button>

<!-- نافذة AI -->
<dialog class="modal" id="ai-modal">
  <div class="sheet">
    <h3>محادثة مع المساعد</h3>
    <div id="chat-box" style="max-height:300px;overflow:auto;background:#111;padding:.8rem;border-radius:12px;font-size:.95rem"></div>
    <div class="row">
      <input id="ai-input" placeholder="اكتب سؤالك..." style="flex:1;padding:.8rem;border-radius:12px" />
      <button class="btn" id="ai-send">إرسال</button>
    </div>
  </div>
</dialog>
</body>
</html>
